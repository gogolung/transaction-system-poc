# README

## Architecture Overview
The whole system architecture consists of 6 major components
- Web server
- Producer
- Consumer
- RabbitMQ
- Redis
- Postgres DB

<kbd>
  <img src="https://drive.google.com/uc?export=view&id=1pRS3v3I6jHGaWxZprjjcfVX_0eTaPOBb">
</kbd>

Messages of transactions are generated by 3 producers and transmitted through rabbitMQ to a consumer. Each producer represents an account, and the consumer will read the messages and make transactions to modify account balances. The transactions will be stored in a table inside the postgres DB.

For demo purpose, a web server written in Rails connects to the DB. A simple web page  is prepared for displaying the account status and the transactions in real time. For details please read the section below.

The redis cache holds a key for each producer to start/stop generating messages.

## Running the project locally
Every component in this project is containerised using Docker. Please make sure Docker is installed in your local machine first. 

Follow the steps to get the system running:  

1. Clone this project, navigate the console to project root

2. Run `docker-compose up -d db rabbitmq redis web`

3. Set up the database
   1. Run `docker ps`, get the container id with the name `transaction-system-poc_web_*`
   2. Run `docker exec -it <db container id> /bin/bash`
   3. Inside the bash of the container, run `rails db:setup`
   4. After migration is done, run `exit`

4. Run `docker-compose up -d --scale consumer=1 --scale producer=3 consumer producer`

5. Open a browser, go to [http://localhost:3000/transactions](http://localhost:3000/transactions)

## Demo Page
You should see the page in [http://localhost:3000/transactions](http://localhost:3000/transactions)

<kbd>
  <img src="https://drive.google.com/uc?export=view&id=170nO1fkC6tpbu728ZGRKnQPZztC8nqez">
</kbd>

There are 1 bank account, 3 user accounts. The user accounts are assigned random positive balances. 

The system is designed based on a zero-sum practice, therefore the bank account is introduced to hold the total balance it gave to the user accounts. The bank balance should always be negative, so that when all balances add up the result is always zero.

The transactions are displayed in the table below. 3 transactions were made for the topup of the initial balances.

Transaction types:
- Topup - Deduct `amount` from `transferrer` (bank for this demo) account, add it to `receiver` (user/producer account)
- Payment - Deduct `amount` from `receiver` (user/producer account), add it to `transferrer` (bank for this demo) account. Payment may fail if the `receiver` account is not enough to make this payment

#### Let's start this demo!
- Click `Start all producers` link
- Wait and observe the `Transactions` table (The page auto refreshes every 3 sec)
<kbd>
  <img src="https://drive.google.com/uc?export=view&id=1tfJD2bLNLxPQFOalTNLQ7M4yfaM-qV4A">
</kbd>

- Click `Stop all producers` to take a break, or you could try to toggle each producer by clicking the `Toggle On/Off` button
- Click `Reset all (...)` to clear all transactions and get back to initial state

#### The queue is durable!  

The queue is set to be durable. If the consumer dies, the messages will be stored in the queue. When the consumer is back live, the messages will be processed.
- Stop all producers and reset all
- Kill the consumer
   - Run `docker ps`, get the container id with name `transaction-system-poc_consumer_1`
   - Run `docker kill <consume container id>`
- On the web page, `start all producers`, wait for 10 sec, there should not be any new transaction
- `Stop all producers`
- Restart the RabbitMQ
   - Run `docker ps`, get the container id with name `transaction-system-poc_rabbitmq_1`
   - Run `docker restart <rabbitmq container id>`
- Run `docker-compose up -d consumer`
- Go back to web page, the transactions pop up

You can access the RabbitMQ dashboard by [http://localhost:15672](http://localhost:15672), the username/password are `guest`/`guest`

